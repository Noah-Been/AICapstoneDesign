# LS증권 API 가격 스냅샷 진행로그 — 2025-10-16 (KST)

## 개요
- 목표: KOSPI200+KOSDAQ150(총 350) 종목의 최근 일봉 시세(≥120 캔들) 로컬 스냅샷 수집 → 향후 신호 계산/리포트 생성의 기초 데이터 확보
- 상태: 350종 전량 수집 완료, 스냅샷 저장 구조 확정, 배치 재실행/재개 가능

## 환경 정리
- 가상환경: `빅데이터캡디/mvp/.venv`
- 의존성: `빅데이터캡디/mvp/requirements.txt`
  - httpx, beautifulsoup4, lxml, tenacity, loguru, pydantic
- 주요 스크립트
  - `apps/ls_t1305.py`: LS OpenAPI t1305(기간별 주가) 호출 + CSV 저장, 연속조회 처리, MOCK 지원
  - `apps/batch_prices.py`: 티커 목록 일괄 수집(초당 1건), 실패 건 재시도/재개 용이

## 키/인증
- 환경변수
  - `LS_APP_KEY`, `LS_SECRET_KEY` (필수)
  - `LS_BASE_URL`(기본 `https://openapi.ls-sec.co.kr:8080`), `LS_TR_GATEWAY_PATH`(기본 `/stock/market-data`)
  - `LS_VERIFY_SSL`(기본 1; 필요시 0으로 테스트), `LS_MAC_ADDRESS`(법인 계정일 때)
- 토큰 발급(curl 예시)
  - `POST https://openapi.ls-sec.co.kr:8080/oauth2/token` (x-www-form-urlencoded)
  - 파라미터: `grant_type=client_credentials`, `appkey`, `appsecretkey`, `scope=oob`

## 수집 스냅샷 구조
- 날짜별 루트: `빅데이터캡디/mvp/data/snapshots/YYYY-MM-DD`
  - 가격: `.../prices/{티커}.csv` (헤더 포함 121행 = 120캔들 + 헤더)
- 오늘 수집 경로: `빅데이터캡디/mvp/data/snapshots/2025-10-16/prices`

## 단일 수집(샘플)
- 명령: `python apps/ls_t1305.py --shcode 005930 --cnt 120 --csv "data/snapshots/$SNAPSHOT_DATE/prices/005930.csv"`
- 결과 예: `빅데이터캡디/mvp/data/snapshots/2025-10-16/prices/005930.csv:1`
  - 헤더 포함 121행, 최신→과거 순 정렬

## 티커 목록(350개) 생성
- 입력 파일: `mvp/data/KOSPI200.csv`, `mvp/data/KOSDDAQ150.csv` (CP949 인코딩)
- 처리: CP949→UTF-8 변환/파싱 후 첫 컬럼(6자리) 추출, 중복 제거
- 출력: `빅데이터캡디/mvp/tickers.txt:1` (총 350줄)

## 350개 일괄 수집
- 준비
  - `export SNAPSHOT_DATE=$(TZ=Asia/Seoul date +%F)`
  - `mkdir -p data/snapshots/$SNAPSHOT_DATE/prices`
- 실행
  - `python apps/batch_prices.py --tickers tickers.txt --cnt 120 --sleep-sec 1.0 --snapshot-date "$SNAPSHOT_DATE" --skip-existing`
- 결과
  - 요약: `success=350, fail=0`
  - 출력 경로: `빅데이터캡디/mvp/data/snapshots/2025-10-16/prices`

## 검증 포인트
- 파일 수: `ls -1 .../prices | wc -l` → 350
- 행수: 임의 CSV `wc -l` → 121(헤더 포함)
- 컬럼: `date, open, high, low, close, volume, ...` 존재, `shcode` 6자리 유지

## 운영/안전 메모
- 레이트리밋: t1305 초당 1건 → `--sleep-sec 1.0` 권장
- 재실행: `--skip-existing`로 이미 저장된 종목은 건너뜀(부분 실패 복구 용이)
- 보안: 키는 환경변수/로컬 .env에만 저장, 채팅/로그 공유 지양(필요 시 Secret 재발급)
- Excel 주의: CSV 열을 숫자로 열면 선행 0이 사라짐 → 텍스트 또는 pandas `dtype=str`

## 이슈/해결 기록
- 토큰 403: 플레이스홀더/승인/줄바꿈 오류 → 실제 키·한 줄 커맨드로 해결
- 경로 오타: `--csv` 인자 줄바꿈 섞임 → 한 줄로 입력하여 정상 저장
- 문자셋: KOSPI/KOSDAQ CSV가 CP949 → 파서에서 CP949 처리로 해결

## 다음 단계 제안(TODO)
1) 신호 계산 v0: 60일 신고가 근접도, 20D 수익률, 거래대금 분위수, MA 상회 → Top N 선정
2) 리포트 템플릿 v0: Markdown로 카드 N개 렌더링(시세 포인트 중심)
3) 뉴스(5일) 수집: 네이버 API 키로 Top N 대상만 수집·중복 제거·요약(2–3문장)
4) 리포트 메타 v0: 5개 하우스 리스트 페이지 메타만 수집(링크·의견·목표가)
5) 스케줄링: 간단 cron으로 새벽 수집→아침 리포트 생성

---
작성: 2025-10-16 01:10 KST
\n+## 신호 계산 · TOP10 선정 (2025-10-16)
- 입력: `data/snapshots/YYYY-MM-DD/prices/*.csv` (각 120캔들, 최신→과거)
- 기준(lookback=60):
  - `proximity_pct = (high60 - close0) / high60 * 100` → 0%일수록 60일 신고가에 근접
  - `ret20_pct = (close0 / close_20 - 1) * 100` (최근 20영업일 수익률)
  - `vol_percentile`: 최근 거래량의 60일 백분위(0–100)
  - MA 상태: `above_ma20`(종가>MA20), `ma20_gt_ma60`(MA20>MA60)
- 점수(0–100, 가중합):
  - `proximity_score = 100 - proximity_pct` (가중치 0.5)
  - `ret20_pct` 정규화 [-20%, +20%] → [0,100] (0.3)
  - `vol_percentile` (0.15)
  - MA 포인트: (종가>MA20 +50) + (MA20>MA60 +50) (0.05)
- 산출물:
  - 전체 신호 JSONL: `data/snapshots/2025-10-16/rank_signals.jsonl`
    - 각 행: `ticker, date, score, metrics{close, high60, proximity_pct, proximity_score, ret20_pct, vol_percentile, ma20, ma60, above_ma20, ma20_gt_ma60}`
  - 상위 N JSON: `data/snapshots/2025-10-16/topN.json` (N=10)
- 오늘 실행 결과:
  - 350개 종목 신호 계산 완료, 점수 내림차순 정렬 후 Top 10 선별
  - 콘솔 미리보기로 상위 10개 티커/점수/핵심 지표 확인
- 주의/한계:
  - 섹터 쏠림 제한 및 점수 하한 미적용(원하면 추가 가능)
  - 거래대금 대신 거래량 사용(대금 컬럼 확보 시 교체 권장)
  - 뉴스/실적 이벤트 미반영(다음 단계에서 보강 예정)
